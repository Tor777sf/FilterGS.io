//descripcion undefenid , ventana emergente undefenid , precio y total $NaN//descripcion undefenid , ventana emergente undefenid , precio y total $NaN

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sheet CSV</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>

<table id="myDataTable" class="display">
  <!-- DataTable content will be dynamically generated here -->
</table>

<!-- Nueva sección para la lista de compra -->
<div id="shoppingList">
  <h2>Lista de Compra</h2>
  <ul id="shoppingItems">
    <!-- Los ítems de la lista de compra se agregarán aquí dinámicamente -->
  </ul>
  <p>Total de Compra: <span id="totalPurchase">$0.00</span></p>
</div>

<script>
  $(document).ready(function () {
    // Descargar y parsear el archivo CSV
    Papa.parse('https://docs.google.com/spreadsheets/d/1X0WN5st8Bl6G6_QPtC9gS6vY4PyFR5dAjXxWU7UiOYE/export?format=csv&gid=0', {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function (results) {
        // Crear DataTable
        var dataTable = $('#myDataTable').DataTable({
          data: results.data,
          columns: Object.keys(results.data[0]).map(function(key) {
            return { data: key, title: key };
          }),
          columnDefs: [
            {
              targets: 10,
              render: function (data, type, row) {
                // Personalizar renderizado para la columna con enlaces no vacíos
                return data && data !== "" ? '<a href="' + data + '" target="_blank"><img src="ruta_del_icono.png" alt="Ver Foto" /></a>' : "";
              }
            }
          ]
        });

        // Nueva lista de compra
        var shoppingList = [];
        var totalPurchase = 0;

        // Agregar evento clic para generar lista de compra
        $('#myDataTable tbody').on('click', 'tr', function () {
          var data = dataTable.row(this).data(); // Obtener datos de la fila clicada
          
          // Pedir al usuario ingresar la cantidad
          var quantity = prompt('Ingrese la cantidad para "' + data.producto + '":', 1);

          if (quantity !== null && !isNaN(quantity) && quantity > 0) {
            // Calcular el total por producto y por línea
            var totalItem = parseFloat(data.precio) * parseInt(quantity);
            totalPurchase += totalItem;

            // Agregar a la lista de compra y mostrar el total
            shoppingList.push({
              producto: data.producto,
              cantidad: quantity,
              total: totalItem.toFixed(2)
            });

            // Actualizar la lista de compra y el total global en la interfaz
            updateShoppingList();
          } else {
            alert('Cantidad no válida. Intente de nuevo.');
          }
        });

        // Función para actualizar la lista de compra en la interfaz
        function updateShoppingList() {
          var shoppingItems = $('#shoppingItems');
          var totalPurchaseElement = $('#totalPurchase');

          // Limpiar lista de compra
          shoppingItems.empty();

          // Construir y agregar nuevos elementos a la lista de compra
          for (var i = 0; i < shoppingList.length; i++) {
            var item = shoppingList[i];
            var listItem = '<li>' + item.cantidad + 'x ' + item.producto + ' - Total: $' + item.total + '</li>';
            shoppingItems.append(listItem);
          }

          // Actualizar el total de la compra global
          totalPurchaseElement.text('$' + totalPurchase.toFixed(2));
        }
      }
    });
  });
</script>

</body>
</html>
