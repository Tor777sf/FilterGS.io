<!--segundo nivel 2.1-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sheet CSV</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
  <script src="https://cdn.jsdelivr.net/npm/whatsapp-click-to-chat/dist/index.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

  <style>
    /* Coloca aqu√≠ el bloque de estilos CSS */
    .shopping-item {
      font-size: 16px;
      list-style-type: none;
      padding: 8px 0;
      border-bottom: 1px solid #ccc;
    }

    .item-quantity {
      display: inline-block;
      width: 10%;
    }

    .item-description {
      display: inline-block;
      width: 50%;
    }

    .item-total {
      display: inline-block;
      width: 30%;
      text-align: right;
    }
  </style>

</head>
<body>

<!-- Nueva secci√≥n para la lista de compra -->
<div id="shoppingList">
  <h2>Lista de Compra</h2>
  <ul id="shoppingItems">
    <!-- Los √≠tems de la lista de compra se agregar√°n aqu√≠ din√°micamente -->
  </ul>
  <p>Total de Compra: <span id="totalPurchase">$0.00</span></p>
  <button id="whatsappButton">Compartir por WhatsApp</button>
  <button id="downloadPDFButton">Descargar PDF</button>

</div>
  
<table id="myDataTable" class="display">
  <!-- DataTable content will be dynamically generated here -->
</table>



<script>
  $(document).ready(function () {
    // Descargar y parsear el archivo CSV
    Papa.parse('https://docs.google.com/spreadsheets/d/1X0WN5st8Bl6G6_QPtC9gS6vY4PyFR5dAjXxWU7UiOYE/export?format=csv&gid=0', {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function (results) {
        // Crear DataTable
        var dataTable = $('#myDataTable').DataTable({
          data: results.data,
          columns: Object.keys(results.data[0]).map(function(key) {
            return { data: key, title: key };
          }),
          columnDefs: [
            {
              targets: 10,
              render: function (data, type, row) {
                // Personalizar renderizado para la columna con enlaces no vac√≠os
                return data && data !== "" ? '<a href="' + data + '" target="_blank"><img src="ruta_del_icono.png" alt="Ver Foto" /></a>' : "";
              }
            }
          ]
        });

        // Nueva lista de compra
        var shoppingList = [];
        var totalPurchase = 0;

// ...

// Agregar evento clic para generar lista de compra
$('#myDataTable tbody').on('click', 'tr', function () {
  var data = dataTable.row(this).data(); // Obtener datos de la fila clicada

  // Verificar si la descripci√≥n del producto est√° definida
  if (data && data.DESCRIPCION) {
    // Pedir al usuario ingresar la cantidad
    var quantity = prompt('Ingrese la cantidad para "' + data.DESCRIPCION + '":', 1);

    if (quantity !== null && !isNaN(quantity) && quantity > 0) {
      // Calcular el total por producto y por l√≠nea
      var totalItem = parseFloat(data.Total) * parseInt(quantity);
      totalPurchase += totalItem;

      // Agregar a la lista de compra y mostrar el total
      shoppingList.push({
        producto: data.DESCRIPCION,
        cantidad: quantity,
        total: totalItem.toFixed(2)
      });

      // Actualizar la lista de compra y el total global en la interfaz
      updateShoppingList();
    } else {
      alert('Cantidad no v√°lida. Intente de nuevo.');
    }
  } else {
    alert('Descripci√≥n del producto no definida. Intente de nuevo.');
  }
});

// .

// ...
//   inicio botones Whatsapp y pdf
<!-- Script -->
<script>
  // Funci√≥n para formatear la lista de compra
  function formatShoppingList() {
    let formattedList = 'üìã Lista de Compra:\n\n';
    for (let i = 0; i < shoppingList.length; i++) {
      const item = shoppingList[i];
      formattedList += `üõí ${item.cantidad}x ${item.producto} - Total: $${item.total}\n`;
      formattedList += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n'; // L√≠nea decorativa
    }
    formattedList += `\nüí∞ Total de Compra: $${totalPurchase.toFixed(2)}`;
    return formattedList;
  }

  // Descargar PDF al hacer clic en el bot√≥n "Descargar PDF"
  $('#downloadPDFButton').on('click', async function () {
    try {
      // Crear el objeto PDF en blanco
      const pdfDoc = await PDFLib.PDFDocument.create();

      // Agregar una nueva p√°gina al PDF
      const page = pdfDoc.addPage();

      // Establecer el tama√±o y la posici√≥n del texto
      const textSize = 12;
      const textX = 20;
      const textY = 750;

      // Obtener la lista de compra formateada
      const formattedList = formatShoppingList();

      // Agregar texto a la p√°gina utilizando la fuente predeterminada
      page.drawText(formattedList, { x: textX, y: textY, size: textSize });

      // Guardar el PDF como un blob
      const pdfBytes = await pdfDoc.save();

      // Crear el enlace de descarga para el PDF
      const downloadLink = document.createElement('a');
      downloadLink.href = URL.createObjectURL(new Blob([pdfBytes], { type: 'application/pdf' }));
      downloadLink.download = 'Lista_de_Compra.pdf';

      // Simular un clic en el enlace para abrir la ventana de descarga
      downloadLink.click();
    } catch (error) {
      alert('Error al crear/descargar el PDF: ' + error.message);
    }
  });

  // Funci√≥n para compartir en WhatsApp al hacer clic en el bot√≥n
  $('#whatsappButton').on('click', function () {
    // Obtener la lista de compra formateada
    const formattedList = formatShoppingList();

    // Generar el enlace de WhatsApp con el mensaje
    const link = window.WhatsappClickToChat.createChatLink({
      phone: '929963950', // Reemplazar con el n√∫mero de tel√©fono al que se enviar√° el mensaje
      message: formattedList // Usar el mensaje formateado
    });

    // Abrir el enlace en una nueva ventana
    window.open(link, '_blank');
  });
</script>

// fin botones Whatsapp y pdf

        
        // Funci√≥n para actualizar la lista de compra en la interfaz
        function updateShoppingList() {
          var shoppingItems = $('#shoppingItems');
          var totalPurchaseElement = $('#totalPurchase');

          // Limpiar lista de compra
          shoppingItems.empty();

          // Construir y agregar nuevos elementos a la lista de compra
          for (var i = 0; i < shoppingList.length; i++) {
            var item = shoppingList[i];
            var listItem = '<li class="shopping-item">' +
               '<span class="item-quantity">' + item.cantidad + 'x</span>' +
               '<span class="item-description">' + item.producto + '</span>' +
               '<span class="item-total">Total: $' + item.total + '</span>' +
               '</li>';

            shoppingItems.append(listItem);
          }

          // Actualizar el total de la compra global
          totalPurchaseElement.text('$' + totalPurchase.toFixed(2));
        }
      }
    });
  });
</script>

</body>
</html>
